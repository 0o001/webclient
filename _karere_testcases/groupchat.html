<!DOCTYPE html>
<html>
<head>
    <title></title>
    <!-- language patch -->
    <script type="text/javascript">l = [];</script>

    <script type="text/javascript" src="../js/jquery-min-1.8.1.js"></script>
    <script type="text/javascript" src="../js/functions.js"></script>
    <script type="text/javascript" src="../js/vendor/chat/strophe.js"></script>
    <script type="text/javascript" src="../js/vendor/chat/strophe.disco.js"></script>
    <script type="text/javascript" src="../js/vendor/chat/strophe.jingle.js"></script>
    <script type="text/javascript" src="../js/vendor/chat/strophe.jingle.session.js"></script>
    <script type="text/javascript" src="../js/vendor/chat/strophe.jingle.sdp.js"></script>
    <script type="text/javascript" src="../js/vendor/chat/strophe.jingle.adapter.js"></script>
    <script type="text/javascript" src="../js/vendor/chat/strophe.muc.js"></script>
    <script type="text/javascript" src="../js/vendor/chat/strophe.roster.js"></script>
    <script type="text/javascript" src="../js/vendor/chat/wildemitter.patched.js"></script>
    <script type="text/javascript" src="../js/vendor/chat/hark.patched.js"></script>

    <script type="text/javascript" src="../js/vendor/chat/salsa20.js"></script>
    <script type="text/javascript" src="../js/vendor/chat/bigint.js"></script>
    <script type="text/javascript" src="../js/vendor/chat/crypto.js"></script>
    <script type="text/javascript" src="../js/vendor/chat/eventemitter.js"></script>
    <script type="text/javascript" src="../js/vendor/chat/otr.js"></script>

    <script type="text/javascript" src="../js/chat/rtcSession.js"></script>

    <script type="text/javascript" src="../js/chat/karere.js"></script>


    <script type="text/javascript">
        /**
         * Basic Group Chat Test case
         */
        $(function() {
            /* global */
            k1 = new Karere({
                "clientName": 'karere-testcase'
            });



            /* global */
            k2 = new Karere({
                "clientName": 'karere-testcase'
            });


            var k1_connect_promise = k1.connect(
                    "test1@sandbox.developers.mega.co.nz",
                    "test1"
            );

            var k2_connect_promise = k2.connect(
                    "test2@sandbox.developers.mega.co.nz",
                    "test2"
            );



            $.when(
                   k1_connect_promise,
                   k2_connect_promise
                )
                .done(function(statuses) {
                    console.debug("Starting new chat...");

                    // start chat between k1 and k2
                    var $promise = k1.startChat([
                        k2.getBareJid(),
                        "test3@sandbox.developers.mega.co.nz"
                    ]);

                    $promise.done(function(room_jid) {
                        console.debug("Starting new chat...Done.");

                        // leave chat
                        setTimeout(function() {
                            k2
                                .leaveChat(room_jid)
                                .done(function() {

                                    window.room_jid = room_jid;
                                    console.debug("k2 left chat...");

                                    // add user to chat
                                    k1.addUserToChat(
                                        room_jid,
                                        k2.getJid()
                                    ).done(function() {
                                        console.debug("added k2 to the chat...");
                                        // wait k2 to join first
                                        setTimeout(function() {
                                            // kick k2
                                            console.log("Removing k2 from chat")

                                            k1
                                                .removeUserFromChat(
                                                    room_jid,
                                                    k2.getJid()
                                                )
                                                .done(function() {
                                                    k1.addUserToChat(
                                                        room_jid,
                                                        k2.getJid()
                                                    ).done(function() {
                                                        console.log("added user to the chat (again)");
                                                    });
                                                });

                                        }, 3000);
                                    }).fail(function() {
                                        console.error("k2 NOT added to the chat.", arguments)
                                    });

                                    // send msg

                                    console.debug("sending chat msg to: ", room_jid);
                                    k1._rawSendMessage(room_jid, "groupchat", "hello world!");
                                });
                        }, 10000);
                    }).fail(function(e) {
                        console.error("Cant join room: ", e);
                    });

                }).fail(function(e) {
                    console.error("Cant connect: ", e);
                });


        });
    </script>
</head>
<body>

</body>
</html>